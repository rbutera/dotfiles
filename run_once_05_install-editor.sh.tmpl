#!/bin/bash

NVIM_CONFIG_REPO="git@github.com:rbutera/astronvim_config.git"
NVIM_CONFIG_DIR="$HOME/.config/nvim"

install_bob() {
  echo "Installing bob (neovim version manager)..."
  cargo install bob-nvim

  echo "Installing latest stable neovim..."
  bob install stable
  bob use stable

  echo "Neovim installed at: $(bob which)"
}

install_nvim_config() {
  echo "Setting up Neovim config..."

  # Backup existing config if present
  if [[ -d "$NVIM_CONFIG_DIR" ]]; then
    echo "Backing up existing nvim config..."
    mv "$NVIM_CONFIG_DIR" "$NVIM_CONFIG_DIR.backup.$(date +%Y%m%d%H%M%S)"
  fi

  # Clone AstroNvim
  echo "Cloning AstroNvim..."
  git clone --depth 1 https://github.com/AstroNvim/template "$NVIM_CONFIG_DIR"

  # Remove template's git history
  rm -rf "$NVIM_CONFIG_DIR/.git"

  # Clone personal config
  echo "Cloning personal AstroNvim config..."
  if [[ -d "$NVIM_CONFIG_DIR/lua/user" ]]; then
    rm -rf "$NVIM_CONFIG_DIR/lua/user"
  fi
  git clone "$NVIM_CONFIG_REPO" "$NVIM_CONFIG_DIR/lua/user"

  # Initialize neovim (install plugins)
  echo "Installing Neovim plugins (this may take a moment)..."
  nvim --headless +q 2>/dev/null || true

  echo "Neovim config installed!"
}

prompt_for_install() {
  read -p "Install bob + neovim + config? (y/Y) " -n 1 -r
  echo
  if [[ $REPLY =~ ^[Yy]$ ]]; then
    if ! command -v cargo &> /dev/null; then
      echo "Rust/cargo not found. Please run the rust setup script first."
      exit 1
    fi
    install_bob
    install_nvim_config
  else
    echo "Declined. Skipping bob and nvim"
  fi
}

prompt_for_install
