# Executes commands at the start of an interactive session.

# Source Prezto.
if [[ -s "${ZDOTDIR:-$HOME}/.zprezto/init.zsh" ]]; then
  source "${ZDOTDIR:-$HOME}/.zprezto/init.zsh"
fi

# finds the process using a particular port and kills it
killport() { local PORT=$(lsof -n -i4TCP:$1 | grep LISTEN | awk '{ print $2 }'); kill -9 $PORT }

alias rr="source ~/.zshrc; clear"

{{- if and (eq .chezmoi.os "linux") .wsl }}
# WSL: ensure keyring backend support for tools like gog (secrets keychain)
if command -v gnome-keyring-daemon >/dev/null 2>&1; then
  # start keyring daemon once per shell session
  if [[ -z "${GNOME_KEYRING_CONTROL:-}" ]]; then
    eval "$(gnome-keyring-daemon --start --components=secrets 2>/dev/null)" || true
    export SSH_AUTH_SOCK
  fi
fi
{{ end }}

{{- if eq .chezmoi.os "linux" }}
# SSH key helper (separate from secrets keyring backend)
if command -v keychain >/dev/null 2>&1; then
  keychain -q --nogui "$HOME/.ssh/id_ed25519" 2>/dev/null
  [[ -f "$HOME/.keychain/$HOST-sh" ]] && source "$HOME/.keychain/$HOST-sh"
fi
{{ end }}

# Cursor shape for vi mode
function zle-keymap-select () {
  case $KEYMAP in
    vicmd) echo -ne '\e[1 q';; # block
    viins|main) echo -ne '\e[5 q';; # beam
  esac
}
zle -N zle-keymap-select

zle-line-init() {
  zle -K viins
  echo -ne "\e[5 q"
}
zle -N zle-line-init
echo -ne '\e[5 q'
preexec() { echo -ne '\e[5 q' ;}

# vi mode ctrl+R
bindkey "^R" history-incremental-search-backward

# load aliases
source ~/.aliases

# asdf version manager
if [[ -f "/opt/asdf-vm/asdf.sh" ]]; then
  . /opt/asdf-vm/asdf.sh
elif [[ -f "$HOME/.asdf/asdf.sh" ]]; then
  . "$HOME/.asdf/asdf.sh"
elif command -v brew &> /dev/null && [[ -f "$(brew --prefix asdf)/libexec/asdf.sh" ]]; then
  . "$(brew --prefix asdf)/libexec/asdf.sh"
fi

# fzf
if command -v fzf &> /dev/null; then
  source <(fzf --zsh)
fi

# zoxide (modern cd)
if command -v zoxide &> /dev/null; then
  eval "$(zoxide init zsh)"
fi

# starship prompt
eval "$(starship init zsh)"


# OpenClaw Completion
[[ -f "/home/rai/.openclaw/completions/openclaw.zsh" ]] && source "/home/rai/.openclaw/completions/openclaw.zsh"

# opencode
export PATH=/home/rai/.opencode/bin:$PATH

# stop windows WSL / nodejs appearing in wsl path
export PATH=$(echo $PATH | tr ':' '\n' | grep -v 'AppData.*npm\|nodejs' | tr '\n' ':')

# SDKMAN (must be at end)
export SDKMAN_DIR="$HOME/.sdkman"
[[ -s "$HOME/.sdkman/bin/sdkman-init.sh" ]] && source "$HOME/.sdkman/bin/sdkman-init.sh"
